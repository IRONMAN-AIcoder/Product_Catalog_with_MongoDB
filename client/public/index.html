<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Product Catalog</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- This is the beautiful UI stylesheet you provided -->
    <style>
        :root {
            --primary-color: #007bff; --primary-hover: #0056b3; --background-color: #f8f9fa;
            --card-background: #ffffff; --text-color: #212529; --light-text-color: #6c757d;
            --border-color: #dee2e6; --star-color: #ffc107; --danger-color: #dc3545;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08); --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        body { margin: 0; font-family: 'Poppins', sans-serif; background-color: var(--background-color); }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem; }
        
        /* Header, Search, and Filter styles */
        .product-catalog-header { text-align: center; margin-bottom: 2rem; }
        .product-catalog-header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .product-catalog-header p { font-size: 1.1rem; color: var(--light-text-color); }
        .search-container { margin-bottom: 1.5rem; }
        .search-box { position: relative; width: 100%; max-width: 600px; margin: 0 auto; }
        .search-box input { width: 100%; padding: 1rem 1rem 1rem 3.5rem; font-size: 1.1rem; border-radius: 50px; border: 1px solid var(--border-color); box-sizing: border-box; transition: all 0.2s ease; }
        .search-box input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.2); }
        .search-icon { position: absolute; left: 1.25rem; top: 50%; transform: translateY(-50%); width: 22px; height: 22px; color: var(--light-text-color); }
        .filter-container { display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; align-items: center; margin-bottom: 3rem; }
        .filter-container input, .filter-container select, .filter-container button { padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; font-family: 'Poppins', sans-serif; font-size: 0.95rem; background-color: var(--card-background); }
        .filter-container .reset-btn { cursor: pointer; }
        .filter-container .reset-btn:hover { background-color: #e9ecef; }
        
        /* Admin Header */
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; background: #fff; padding: 1rem 1.5rem; border-radius: 12px; box-shadow: var(--shadow); }
        .admin-header h1 { font-size: 1.5rem; margin: 0; }
        .admin-actions button { padding: 0.6rem 1.2rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; }
        .btn-add { background-color: var(--primary-color); color: white; margin-right: 1rem; }
        .btn-logout { background-color: var(--danger-color); color: white; }

        /* Product Grid & Card styles */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2rem; }
        .product-card { background-color: var(--card-background); border-radius: 12px; box-shadow: var(--shadow); display: flex; flex-direction: column; overflow: hidden; transition: all 0.3s ease; }
        .product-card:hover { transform: translateY(-8px); box-shadow: var(--shadow-hover); }
        .product-image-placeholder { height: 220px; background-color: #e9ecef; display: flex; justify-content: center; align-items: center; }
        .product-image-placeholder svg { width: 50px; height: 50px; color: #adb5bd; }
        .product-info { padding: 1.25rem; display: flex; flex-direction: column; flex-grow: 1; }
        .product-info h3 { margin: 0 0 0.25rem 0; font-size: 1.2rem; font-weight: 600; }
        .product-info .product-category { color: var(--light-text-color); font-size: 0.9rem; margin-bottom: 1rem; }
        .product-rating { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; }
        .product-rating .stars { color: var(--star-color); }
        .product-rating .rating-text { color: var(--light-text-color); font-size: 0.9rem; }
        .product-footer { margin-top: auto; display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; }
        .product-footer .product-price { font-size: 1.3rem; font-weight: 700; color: var(--primary-color); }
        .admin-controls { display: flex; gap: 0.5rem; }
        .admin-controls button { flex-grow: 1; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border-color); cursor: pointer; }
        .btn-edit { background-color: #ffc107; } .btn-delete { background-color: #dc3545; color: white; }
        .loading-error { text-align: center; color: var(--danger-color); font-size: 1.2rem; padding: 4rem 0; }
        .no-products { grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--light-text-color); }

        /* Modal Styles */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; }
        .modal-form .form-group { margin-bottom: 1rem; }
        .modal-form label { display: block; margin-bottom: 0.5rem; }
        .modal-form input { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; }
        .modal-actions button { padding: 0.6rem 1.2rem; border: none; border-radius: 8px; cursor: pointer; }
        .btn-save { background: var(--primary-color); color: white; } .btn-cancel { background: #6c757d; color: white; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const API_BASE_URL = "http://localhost:5000";

        // --- AUTH & ROUTING ---
        // Simple check on page load. If not logged in, redirect to login page.
        const userRole = sessionStorage.getItem('userRole');
        if (!userRole) {
            window.location.href = './login.html';
        }

        // --- COMPONENTS ---
        const StarRating = ({ rating }) => {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 !== 0; // Simplified for now
            const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
            return <div className="stars">{'★'.repeat(fullStars)}{'☆'.repeat(emptyStars)}</div>;
        };

        const ProductModal = ({ product, onClose, onSave }) => {
            const [formData, setFormData] = useState(product || { name: '', brand: '', category: '', price: '', rating: '' });
            const handleChange = e => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            const handleSubmit = e => { e.preventDefault(); onSave(formData); };
            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h2>{product ? 'Edit Product' : 'Add New Product'}</h2>
                        <form onSubmit={handleSubmit} className="modal-form">
                             <div className="form-group"><label>Name</label><input name="name" value={formData.name} onChange={handleChange} required/></div>
                            <div className="form-group"><label>Brand</label><input name="brand" value={formData.brand} onChange={handleChange} required/></div>
                            <div className="form-group"><label>Category</label><input name="category" value={formData.category} onChange={handleChange} required/></div>
                            <div className="form-group"><label>Price</label><input type="number" name="price" value={formData.price} onChange={handleChange} required/></div>
                            <div className="form-group"><label>Rating</label><input type="number" step="0.1" min="0" max="5" name="rating" value={formData.rating} onChange={handleChange} required/></div>
                            <div className="modal-actions">
                                <button type="button" className="btn-cancel" onClick={onClose}>Cancel</button>
                                <button type="submit" className="btn-save">Save</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const ProductCard = ({ product, userRole, onEdit, onDelete }) => (
            <div className="product-card">
                <div className="product-image-placeholder"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></div>
                <div className="product-info">
                    <h3>{product.name}</h3>
                    <p className="product-category">{product.brand} - {product.category}</p>
                    <div className="product-rating"><StarRating rating={product.rating} /><span className="rating-text">{product.rating}</span></div>
                    <div className="product-footer">
                        <p className="product-price">₹{product.price.toLocaleString()}</p>
                        {userRole === 'admin' && (
                            <div className="admin-controls">
                                <button className="btn-edit" onClick={() => onEdit(product)}>Edit</button>
                                <button className="btn-delete" onClick={() => onDelete(product._id)}>Delete</button>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );

        const App = () => {
            const [products, setProducts] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);
            
            // Filter states
            const [searchTerm, setSearchTerm] = useState('');
            const [category, setCategory] = useState('All');
            const [minPrice, setMinPrice] = useState('');
            const [maxPrice, setMaxPrice] = useState('');
            const [sort, setSort] = useState('newest');

            const fetchProducts = async () => {
                try {
                    setIsLoading(true);
                    const response = await fetch(`${API_BASE_URL}/api/products`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    setProducts(await response.json());
                } catch (err) {
                    setError('Failed to fetch products. Is the backend server running?');
                } finally {
                    setIsLoading(false);
                }
            };
            
            useEffect(() => { fetchProducts(); }, []);

            const handleSaveProduct = async (productData) => {
                const isEditing = !!productData._id;
                const url = isEditing ? `${API_BASE_URL}/api/products/${productData._id}` : `${API_BASE_URL}/api/products`;
                const method = isEditing ? 'PUT' : 'POST';
                try {
                    const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(productData) });
                    if (!response.ok) throw new Error('Failed to save');
                    fetchProducts();
                    setIsModalOpen(false);
                    setEditingProduct(null);
                } catch (err) { console.error("Save error:", err); }
            };

            const handleDeleteProduct = async (productId) => {
                if (!confirm("Are you sure?")) return;
                try {
                    const response = await fetch(`${API_BASE_URL}/api/products/${productId}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('Failed to delete');
                    fetchProducts();
                } catch (err) { console.error("Delete error:", err); }
            };
            
            const handleLogout = () => {
                sessionStorage.removeItem('userRole');
                window.location.href = './login.html';
            };

            const uniqueCategories = ["All", ...new Set(products.map(p => p.category))];

            const filteredAndSortedProducts = useMemo(() => {
                let tempProducts = [...products]
                    .filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()))
                    .filter(p => category === 'All' || p.category === category)
                    .filter(p => minPrice === '' || p.price >= Number(minPrice))
                    .filter(p => maxPrice === '' || p.price <= Number(maxPrice));
                
                switch (sort) {
                    case 'price-asc': tempProducts.sort((a, b) => a.price - b.price); break;
                    case 'price-desc': tempProducts.sort((a, b) => b.price - a.price); break;
                    case 'rating': tempProducts.sort((a, b) => b.rating - a.rating); break;
                }
                return tempProducts;
            }, [products, searchTerm, category, minPrice, maxPrice, sort]);

            if (isLoading) return <div className="loading-error">Loading...</div>;
            if (error) return <div className="loading-error">{error}</div>;

            return (
                <div className="container">
                    {isModalOpen && <ProductModal product={editingProduct} onClose={() => setIsModalOpen(false)} onSave={handleSaveProduct} />}
                    
                    <header className="admin-header">
                        <h1>Welcome, {userRole}!</h1>
                        <div className="admin-actions">
                            {userRole === 'admin' && <button className="btn-add" onClick={() => { setEditingProduct(null); setIsModalOpen(true); }}>Add Product</button>}
                            <button className="btn-logout" onClick={handleLogout}>Logout</button>
                        </div>
                    </header>

                    <main>
                         <div className="search-container">
                            <div className="search-box">
                                <svg className="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                <input type="text" placeholder="Search for products..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                            </div>
                        </div>

                        <div className="filter-container">
                             <select value={category} onChange={e => setCategory(e.target.value)}>
                                 {uniqueCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                             </select>
                             <input type="number" placeholder="Min price" value={minPrice} onChange={e => setMinPrice(e.target.value)} />
                             <input type="number" placeholder="Max price" value={maxPrice} onChange={e => setMaxPrice(e.target.value)} />
                             <select value={sort} onChange={e => setSort(e.target.value)}>
                                 <option value="newest">Newest</option>
                                 <option value="price-asc">Price: Low to High</option>
                                 <option value="price-desc">Price: High to Low</option>
                                 <option value="rating">Top Rated</option>
                             </select>
                             <button className="reset-btn" onClick={() => { setSearchTerm(''); setCategory('All'); setMinPrice(''); setMaxPrice(''); setSort('newest'); }}>Reset</button>
                        </div>

                        <div className="product-grid">
                            {filteredAndSortedProducts.length > 0 ? (
                                filteredAndSortedProducts.map(product => (
                                    <ProductCard key={product._id} product={product} userRole={userRole} 
                                        onEdit={() => { setEditingProduct(product); setIsModalOpen(true); }}
                                        onDelete={handleDeleteProduct}
                                    />
                                ))
                            ) : <p className="no-products">No products found.</p>}
                        </div>
                    </main>
                </div>
            );
        };
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
